<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PROC√àS-VERBAL D‚ÄôINTERPELLATION ‚Äî App PV</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#003366">
<link rel="icon" href="icon-192.png" sizes="192x192">
<link rel="apple-touch-icon" href="icon-512.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<style>
  :root{
    --page-w:210mm; --page-h:297mm;
    --m-left:30mm; --m-others:25mm;
    --font:"Times New Roman", serif;
    --ui:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    --brand:#003366; --muted:#6b7280; --bg:#0b1220;
  }
  /* ====== PRINT (OFFICIEL) ====== */
  @page{ size:A4; margin: var(--m-others) var(--m-others) var(--m-others) var(--m-left); }
  @media print{
    body{ background:#fff; margin:0 }
    #tabbar, #tab-content, .toolbar, .saved-tab, .mobile-only { display:none!important; }
    .sheet{ margin:0!important; padding: var(--m-others) var(--m-others) var(--m-others) var(--m-left)!important; box-shadow:none!important; width:auto!important; min-height:auto!important; }
  }

  /* ====== MOBILE UI (ONGLETS + FORM) ====== */
  html,body{height:100%; background:#0f172a; margin:0; font-family:var(--ui); color:#e5e7eb;}
  #tabbar{
    position:sticky; top:0; z-index:20; background:#0b1220;
    display:flex; gap:8px; padding:10px; box-shadow:0 1px 0 rgba(255,255,255,.08);
  }
  .tabbtn{
    flex:1; text-align:center; padding:10px 12px; border-radius:10px;
    color:#cbd5e1; background:#162034; border:1px solid rgba(255,255,255,.08);
    font-weight:600; cursor:pointer;
  }
  .tabbtn.active{ background:#233052; color:#fff; border-color:#3b82f6; }
  #tab-content{ padding:12px; }
  .card{
    background:#0f1a33; color:#e5e7eb; border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:14px; margin-bottom:12px;
  }
  .row{ display:flex; gap:10px; flex-wrap:wrap; }
  .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  @media (max-width: 680px){ .grid2{ grid-template-columns: 1fr; } }
  label{ display:block; font-size:12px; color:#93a0b5; margin-bottom:4px; }
  input, select, textarea{
    width:100%; box-sizing:border-box; padding:10px 12px; border-radius:10px;
    border:1px solid rgba(255,255,255,.12); background:#0b1428; color:#fff; font-size:14px;
  }
  textarea{ min-height:90px; }
  .btn{
    background:#3b82f6; border:0; color:#fff; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer;
  }
  .btn.secondary{ background:#64748b; }
  .btn.warn{ background:#ef4444; }
  .btn.ghost{ background:transparent; border:1px dashed rgba(255,255,255,.2); color:#9fb5ff; }
  .btnbar{ display:flex; gap:8px; flex-wrap:wrap; }
  .kicker{ font-size:12px; color:#93a0b5; margin-bottom:8px; }

  /* blocs dynamiques */
  .dyn-block{ border:1px dashed rgba(255,255,255,.16); border-radius:12px; padding:10px; margin-top:8px; }
  .minirow{ display:flex; gap:8px; }
  .w-1-3{ flex:1 1 100px; max-width:140px; }
  .chip{ display:inline-block; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.08); font-size:12px; color:#d1d5db; }
  .list{ display:flex; flex-direction:column; gap:8px; }

  /* ====== PAGE A4 (APER√áU & PRINT) ====== */
  .sheet{
    background:#fff;
    color:#000;
    font-family:var(--font);
    box-shadow:0 8px 24px rgba(0,0,0,.35);
    box-sizing:border-box;
    padding: var(--m-others);
    margin:18px auto;
    border-radius:10px;
    max-width: 920px; /* fluide & lisible */
    width: auto;
    font-size: 17px;
    line-height: 1.6;
  }
  .pv-header{ display:flex; align-items:center; gap:12px; }
  .logo-wrap{ width:120px; height:36px; display:flex; align-items:center; }
  h1{
    text-align:center; text-transform:uppercase; text-decoration:underline;
    font-weight:bold; font-size:20px; letter-spacing:.5px; margin:8px 0 14px 0; color:#000;
  }
  .pv{ font-size:17px; line-height:1.6; text-align:justify; color:#000; }
  .pv p{ margin:0 0 10px 0; }
  .muted{ color:#555; font-style:italic; }
  .signature-row{ display:flex; justify-content:space-between; gap:24px; margin-top:34px; text-align:center; }
  .sig-col{ flex:1; min-height:80px; }
  .sig-title{ font-weight:bold; margin-bottom:46px; }

  /* ====== LISTE DES PV ENREGISTR√âS ====== */
  .saved-tab .item{
    display:flex; justify-content:space-between; align-items:center; gap:10px;
    background:#0f1a33; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px;
  }
  .saved-tab .meta{ display:flex; flex-direction:column; gap:4px; }
  .saved-tab .title{ color:#fff; font-weight:700; }
  .saved-tab .sub{ color:#9aa7bd; font-size:12px; }
/* --- Am√©lioration mobile responsive --- */
@media (max-width: 768px) {
  body {
    font-size: 16px;
    background: #0f172a;
  }

  .card {
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 16px;
  }

  label {
    font-size: 14px;
  }

  input, select, textarea {
    font-size: 16px;
    padding: 12px;
    border-radius: 10px;
  }

  .btn {
    width: 100%;
    font-size: 16px;
    padding: 12px;
  }

  .btnbar {
    flex-direction: column;
  }

  /* --- Feuille PV responsive --- */
.sheet {
  background: #fff;
  color: #000;
  font-family: var(--font);
  box-shadow: 0 4px 18px rgba(0,0,0,.25);
  box-sizing: border-box;
  padding: 20px;
  margin: 20px auto;
  border-radius: 8px;
  width: 100%;
  max-width: 95vw;     /* s‚Äôadapte √† la largeur de l‚Äô√©cran */
  font-size: 18px;     /* texte plus gros sur mobile */
  line-height: 1.7;
}

/* --- Sur grands √©crans (PC / PDF) --- */
@media (min-width: 900px) {
  .sheet {
    width: var(--page-w);
    min-height: var(--page-h);
    margin: 18px auto;
    padding: var(--m-others);
    font-size: 17px;
    line-height: 1.6;
    border-radius: 10px;
    box-shadow: 0 8px 24px rgba(0,0,0,.35);
  }
}

/* --- Am√©lioration mobile responsive --- */
@media (max-width: 768px) {
  body {
    font-size: 16px;
    background: #0f172a;
  }

  .card {
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 16px;
  }

  label {
    font-size: 14px;
  }

  input, select, textarea {
    font-size: 16px;
    padding: 12px;
    border-radius: 10px;
  }

  .btn {
    width: 100%;
    font-size: 16px;
    padding: 12px;
  }

  .btnbar {
    flex-direction: column;
  }

  /* --- Feuille PV responsive --- */
.sheet {
  background: #fff;
  color: #000;
  font-family: var(--font);
  box-shadow: 0 4px 18px rgba(0,0,0,.25);
  box-sizing: border-box;
  padding: 20px;
  margin: 20px auto;
  border-radius: 8px;
  width: 100%;
  max-width: 95vw;     /* s‚Äôadapte √† la largeur de l‚Äô√©cran */
  font-size: 18px;     /* texte plus gros sur mobile */
  line-height: 1.7;
}

/* --- Sur grands √©crans (PC / PDF) --- */
@media (min-width: 900px) {
  .sheet {
    width: var(--page-w);
    min-height: var(--page-h);
    margin: 18px auto;
    padding: var(--m-others);
    font-size: 17px;
    line-height: 1.6;
    border-radius: 10px;
    box-shadow: 0 8px 24px rgba(0,0,0,.35);
  }
}

/* --- En impression, format A4 officiel --- */
@media print {
  .sheet {
    width: var(--page-w);
    min-height: var(--page-h);
    margin: 0;
    padding: var(--m-others) var(--m-others) var(--m-others) var(--m-left);
    font-size: 14px;
    line-height: 1.55;
    box-shadow: none;
    border-radius: 0;
  }
}

  .signature-row {
    flex-direction: column;
    gap: 24px;
  }

  .sig-col {
    min-height: 60px;
  }
}
</style>
</head>
<body>

<!-- BARRE D‚ÄôONGLETS -->
<div id="tabbar">
  <button class="tabbtn active" id="tabNewBtn">üìù Nouveau PV</button>
  <button class="tabbtn" id="tabPreviewBtn">üëÅÔ∏è Aper√ßu / Impression</button>
  <button class="tabbtn" id="tabSavedBtn">üìÇ Mes PV enregistr√©s</button>
</div>

<div id="tab-content">
  <!-- ONGLET 1 : FORM -->
  <div id="tab-new">
    <div class="card">
      <div class="kicker">Service</div>
      <div class="grid2">
        <div><label>Poste</label><input id="poste" type="text" placeholder="ex : La Turbie"></div>
        <div><label>Date de l‚Äôinterpellation</label><input id="datepv" type="date"></div>
        <div><label>Heure</label><input id="heurepv" type="time"></div>
        <div><label>Heure d√©but de service</label><input id="hdeb" type="time"></div>
        <div><label>Heure fin de service</label><input id="hfin" type="time"></div>
      </div>
    </div>

    <div class="card">
      <div class="kicker">R√©dacteur</div>
      <div class="grid2">
        <div><label>Grade</label><input id="agentGrade" type="text" placeholder="ex: Mar√©chal des logis"></div>
        <div><label>Nom & pr√©nom</label><input id="agentNom" type="text" placeholder="Nom Pr√©nom"></div>
        <div><label>Qualit√©</label>
          <select id="agentQualite">
            <option value="">-- Choisir --</option>
            <option>APJ</option><option>APJA</option><option>OPJ</option><option>AFP</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div class="kicker">Assistants</div>
        <button class="btn ghost" type="button" onclick="addAssistant()">‚ûï Ajouter un assistant</button>
      </div>
      <div id="assistants" class="list"></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div class="kicker">Personnes interpell√©es (ESI)</div>
        <button class="btn ghost" type="button" onclick="addESI()">‚ûï Ajouter un ESI</button>
      </div>
      <div id="esis" class="list"></div>
    </div>

    <div class="card">
      <label>Observations / comportement / objets saisis (facultatif)</label>
      <textarea id="observations" placeholder="Renseigner seulement si utile"></textarea>
    </div>

    <div class="card">
      <div class="btnbar">
        <button class="btn" type="button" onclick="goPreview()">‚û°Ô∏è Aper√ßu du PV</button>
        <button class="btn secondary" type="button" onclick="saveCurrentPV()">üíæ Sauvegarder ce PV</button>
        <button class="btn warn" type="button" onclick="clearAll()">üóëÔ∏è Effacer les donn√©es</button>
      </div>
      <div class="kicker" style="margin-top:8px;">üí° Astuce : la saisie est <span class="chip">auto-sauvegard√©e</span> √† chaque modification.</div>
    </div>
  </div>

  <!-- ONGLET 2 : APER√áU / IMPRESSION -->
  <div id="tab-preview" style="display:none;">
    <div class="sheet" id="sheet">
      <div class="pv-header">
        <div class="logo-wrap" aria-label="Gendarmerie nationale">
          <!-- Logo int√©gr√© (remplace par ton PNG base64 si besoin) -->
          <svg viewBox="0 0 300 90" width="120" height="36" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Gendarmerie nationale">
            <rect width="300" height="90" fill="#ffffff"/>
            <rect x="0" y="66" width="300" height="10" fill="#0055A4"/>
            <rect x="0" y="76" width="300" height="10" fill="#EF4135"/>
            <circle cx="35" cy="45" r="16" fill="#003366"/>
            <path d="M35 30c6 5 9 10 9 15s-3 10-9 15c-6-5-9-10-9-15s3-10 9-15z" fill="#fff"/>
            <text x="65" y="48" font-family="Verdana, Arial, sans-serif" font-size="20" fill="#003366" font-weight="700">GENDARMERIE</text>
            <text x="65" y="68" font-family="Verdana, Arial, sans-serif" font-size="12" fill="#003366">nationale</text>
          </svg>
        </div>
        <div style="flex:1"></div>
      </div>
      <h1>PROC√àS-VERBAL D‚ÄôINTERPELLATION</h1>
      <div id="pv" class="pv"><p class="muted">Clique sur ‚ÄúAper√ßu du PV‚Äù dans l‚Äôonglet pr√©c√©dent.</p></div>
      <div id="signatures" class="signature-row" style="visibility:hidden;">
        <div class="sig-col"><div class="sig-title">L‚ÄôOfficier de Police Judiciaire</div></div>
        <div class="sig-col"><div class="sig-title">Le R√©dacteur</div></div>
        <div class="sig-col"><div class="sig-title" id="sigAssistTitle">L‚ÄôAssistant</div></div>
      </div>
    </div>

    <div class="card mobile-only" style="max-width:920px; margin:0 auto 24px auto;">
      <div class="btnbar">
        <button class="btn" type="button" onclick="printPV()">üñ®Ô∏è Imprimer / PDF</button>
        <button class="btn secondary" type="button" onclick="saveCurrentPV()">üíæ Sauvegarder ce PV</button>
        <button class="btn" type="button" onclick="goBackToEdit()">‚¨ÖÔ∏è Revenir √† la saisie</button>
      </div>
    </div>
  </div>

  <!-- ONGLET 3 : PV enregistr√©s -->
  <div id="tab-saved" class="saved-tab" style="display:none;">
    <div class="card">
      <div class="kicker">Mes PV enregistr√©s</div>
      <div id="savedList" class="list"></div>
      <div class="row" style="justify-content:flex-end; margin-top:8px;">
        <button class="btn warn" type="button" onclick="wipeSaved()">Vider la liste</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =======================
   Utils dates & formats
======================= */
const MOIS = ["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"];
const JOURS = ["dimanche","lundi","mardi","mercredi","jeudi","vendredi","samedi"];

function fmtDateFr(dateStr, timeStr){
  if(!dateStr) return "";
  const d = new Date(dateStr);
  const j = JOURS[d.getDay()], day = d.getDate(), m = MOIS[d.getMonth()], y = d.getFullYear();
  const yTxt = y===2025 ? "deux mille vingt-cinq" : y===2024 ? "deux mille vingt-quatre" : "deux mille " + (y-2000);
  const heureTxt = timeStr ? ` √† ${timeStr.replace(":", " h ")}` : "";
  return `l‚Äôan ${yTxt}, le ${j} ${day} ${m}${heureTxt}`;
}
function nonEmpty(s){ return s && s.trim().length>0; }
function toText(elId){ const el=document.getElementById(elId); return el? (el.value||"").trim() : ""; }

function para(text){ // transforme \\n\\n en paragraphes, garde \\n en br
  const t = text.trim().replace(/\\n{2,}/g,"</p><p>").replace(/\\n/g,"<br>");
  return `<p>${t}</p>`;
}

/* =======================
   Onglets
======================= */
const tabNewBtn = document.getElementById('tabNewBtn');
const tabPreviewBtn = document.getElementById('tabPreviewBtn');
const tabSavedBtn = document.getElementById('tabSavedBtn');
const tabNew = document.getElementById('tab-new');
const tabPreview = document.getElementById('tab-preview');
const tabSaved = document.getElementById('tab-saved');

function switchTab(which){
  tabNewBtn.classList.remove('active');
  tabPreviewBtn.classList.remove('active');
  tabSavedBtn.classList.remove('active');
  tabNew.style.display='none';
  tabPreview.style.display='none';
  tabSaved.style.display='none';
  if(which==='new'){ tabNewBtn.classList.add('active'); tabNew.style.display='block'; }
  if(which==='preview'){ tabPreviewBtn.classList.add('active'); tabPreview.style.display='block'; }
  if(which==='saved'){ tabSavedBtn.classList.add('active'); tabSaved.style.display='block'; refreshSavedList(); }
}
tabNewBtn.onclick = ()=> switchTab('new');
tabPreviewBtn.onclick = ()=> { generatePV(); switchTab('preview'); };
tabSavedBtn.onclick = ()=> switchTab('saved');

function goPreview(){ generatePV(); switchTab('preview'); }
function goBackToEdit(){ switchTab('new'); }

/* =======================
   Blocs dynamiques
======================= */
let ACOUNT = 0;
let ECOUNT = 0;

function addAssistant(data={}){
  ACOUNT++;
  const wrap = document.getElementById('assistants');
  const box = document.createElement('div');
  box.className = 'dyn-block';
  box.id = `assistant${ACOUNT}`;
  box.innerHTML = `
    <div class="grid2">
      <div>
        <label>Grade</label>
        <input type="text" id="aGrade${ACOUNT}" placeholder="ex: Gendarme" value="${data.grade||""}">
      </div>
      <div>
        <label>Nom & pr√©nom</label>
        <input type="text" id="aNom${ACOUNT}" placeholder="Nom Pr√©nom" value="${data.nom||""}">
      </div>
      <div>
        <label>Qualit√©</label>
        <select id="aQual${ACOUNT}">
          <option value="">-- Choisir --</option>
          ${["APJ","APJA","OPJ","AFP"].map(q=>`<option ${data.qualite===q?"selected":""}>${q}</option>`).join("")}
        </select>
      </div>
      <div style="display:flex; align-items:flex-end; gap:8px;">
        <button type="button" class="btn warn" onclick="removeNode('assistant${ACOUNT}')">Supprimer</button>
      </div>
    </div>`;
  wrap.appendChild(box);
  hookAutosave(box);
}

function addESI(data={}){
  ECOUNT++;
  const wrap = document.getElementById('esis');
  const id = ECOUNT;
  const box = document.createElement('div');
  box.className = 'dyn-block';
  box.id = `esi${id}`;
  box.innerHTML = `
    <div class="grid2">
      <div><label>Nom & pr√©nom</label><input id="eNom${id}" type="text" value="${data.nom||""}"></div>
      <div class="minirow">
        <div class="w-1-3">
          <label>N√© le (jour)</label><input id="eJour${id}" type="number" min="1" max="31" value="${data.jour||""}">
        </div>
        <div class="w-1-3">
          <label>Mois</label><input id="eMois${id}" type="text" placeholder="ex: mars" value="${data.mois||""}">
        </div>
        <div class="w-1-3">
          <label>Ann√©e</label><input id="eAnnee${id}" type="number" min="1900" max="2100" value="${data.annee||""}">
        </div>
      </div>
      <div><label>Lieu de naissance</label><input id="eLieu${id}" type="text" value="${data.lieu||""}"></div>
      <div><label>Pays de naissance</label><input id="ePays${id}" type="text" value="${data.pays||""}"></div>
      <div><label>Adresse</label><input id="eAdresse${id}" type="text" value="${data.adresse||""}"></div>
    </div>

    <div class="grid2">
      <div>
        <label>Heure du contr√¥le</label><input id="eHctrl${id}" type="time" value="${data.hctrl||""}">
      </div>
      <div>
        <label>Heure de l‚Äôinterpellation</label><input id="eHint${id}" type="time" value="${data.hint||""}">
      </div>
    </div>

    <div style="margin-top:8px;">
      <span class="kicker">Documents pr√©sent√©s</span>
      <div class="row">
        <label class="chip"><input type="checkbox" id="ePasseport${id}" ${data.passeport?"checked":""}> Passeport sans visa</label>
        <label class="chip"><input type="checkbox" id="eTitre${id}" ${data.titre?"checked":""}> Titre de s√©jour p√©rim√©</label>
        <label class="chip"><input type="checkbox" id="eAsile${id}" ${data.asile?"checked":""}> Demande d‚Äôasile p√©rim√©e</label>
        <label class="chip"><input type="checkbox" id="eAucun${id}" ${data.aucun?"checked":""}> Aucun document</label>
        <label class="chip"><input type="checkbox" id="eAutre${id}" ${data.autreTxt?"checked":""} onchange="toggleOther(${id})"> Autre</label>
      </div>
      <input type="text" id="eAutreTxt${id}" placeholder="Pr√©ciser" style="margin-top:6px; ${data.autreTxt?'':'display:none;'}" value="${data.autreTxt||""}">
    </div>

    <div style="margin-top:8px;">
      <button type="button" class="btn warn" onclick="removeNode('esi${id}')">Supprimer cet ESI</button>
    </div>
  `;
  wrap.appendChild(box);
  hookAutosave(box);
}

function toggleOther(i){
  const chk = document.getElementById(`eAutre${i}`);
  const fld = document.getElementById(`eAutreTxt${i}`);
  if(chk && fld){ fld.style.display = chk.checked ? "block" : "none"; autosave(); }
}

function removeNode(id){ const el=document.getElementById(id); if(el){ el.remove(); autosave(); }}

/* =======================
   G√©n√©ration du PV
======================= */
function generatePV(){
  const poste = toText('poste');
  const dateTxt = fmtDateFr(toText('datepv'), toText('heurepv'));
  const hdeb = toText('hdeb'), hfin = toText('hfin');

  const agentGrade = toText('agentGrade');
  const agentNom = toText('agentNom');
  const agentQual = toText('agentQualite');

  // Assistants
  const assistants = [];
  for(const child of document.querySelectorAll('#assistants > .dyn-block')){
    const id = child.id.replace('assistant','');
    const g = toText(`aGrade${id}`);
    const n = toText(`aNom${id}`);
    const q = toText(`aQual${id}`);
    if(nonEmpty(n)){
      assistants.push(`${nonEmpty(g)?g+' ':''}${n}${nonEmpty(q)?' en qualit√© de '+q:''}`);
    }
  }

  // ESI
  const esis = [];
  for(const child of document.querySelectorAll('#esis > .dyn-block')){
    const id = child.id.replace('esi','');
    const nom = toText(`eNom${id}`);
    if(!nonEmpty(nom)) continue;
    const jour = toText(`eJour${id}`), mois = toText(`eMois${id}`), annee = toText(`eAnnee${id}`);
    const lieu = toText(`eLieu${id}`), pays = toText(`ePays${id}`), adr = toText(`eAdresse${id}`);
    const hctrl = toText(`eHctrl${id}`), hint = toText(`eHint${id}`);

    // documents
    const docs = [];
    const any = (sel)=> document.getElementById(sel)?.checked;
    if(any(`eAucun${id}`)) docs.push("aucun document");
    else{
      if(any(`ePasseport${id}`)) docs.push("passeport sans visa");
      if(any(`eTitre${id}`)) docs.push("titre de s√©jour p√©rim√©");
      if(any(`eAsile${id}`)) docs.push("demande d‚Äôasile p√©rim√©e");
      if(any(`eAutre${id}`)){
        const extra = toText(`eAutreTxt${id}`);
        if(nonEmpty(extra)) docs.push("autre : " + extra);
      }
    }

    // identit√©
    const identParts = [];
    identParts.push(nom);
    if(jour || mois || annee){ identParts.push(`n√©(e) le ${[jour,mois,annee].filter(nonEmpty).join(" ")}`); }
    if(lieu || pays){ identParts.push(`√† ${lieu}${pays?` (${pays})`:''}`); }
    if(adr){ identParts.push(`demeurant au ${adr}`); }

    // contr√¥le / interpellation
    let flow = "";
    if(hctrl){ flow += `√Ä ${hctrl.replace(":", " h ")}, nous avons proc√©d√© au contr√¥le de ${nom}. `; }
    if(hint){ flow += `Suite √† ce contr√¥le, nous l‚Äôavons interpell√© √† ${hint.replace(":", " h ")}.`; }

    const docLine = docs.length ? ` Documents pr√©sent√©s : ${docs.join(", ")}.` : "";
    const bloc = `${identParts.join(", ")}.${docLine}${flow? " " + flow : ""}`;
    esis.push(bloc.trim());
  }

  // Construction
  let html = "";
  html += para(`Vu les articles L.611-1 et suivants, L.613-1 et L.821-1 du CESEDA relatifs aux conditions de s√©jour des √©trangers et √† la r√©tention administrative, et l‚Äôarticle 73 du Code de proc√©dure p√©nale.`);

  const introParts = [];
  if(dateTxt) introParts.push(`${dateTxt},`);
  const redac = `Nous, le ${[agentGrade,agentNom].filter(nonEmpty).join(" ")}`;
  introParts.push(redac + (agentQual?`, en qualit√© de ${agentQual}`:"") + (poste?`, en fonction au poste de ${poste}`:"") + ((hdeb||hfin)?`, de ${hdeb||"__"} √† ${hfin||"__"}`:""));
  if(assistants.length) introParts.push(assistants.length>1 ? `assist√©s de ${assistants.join(", ")}` : `assist√© de ${assistants[0]}`);
  html += para(introParts.join(" ") + ",");

  if(esis.length){
    html += para("avons proc√©d√© √† l‚Äôinterpellation de :\n\n" + esis.join("\n\n"));
  }

  const obs = toText('observations');
  if(nonEmpty(obs)){ html += para("Observations :\n" + obs); }

  html += para(`Les droits pr√©vus aux articles 63-1 et suivants du Code de proc√©dure p√©nale ont √©t√© notifi√©s : droit √† l‚Äôinformation, droit d‚Äôavertir un proche ou son consulat, droit √† un avocat, droit √† un interpr√®te et droit √† un examen m√©dical.`);

  html += para("Dont acte, dress√© pour valoir ce que de droit.");

  if(poste || toText('datepv')){
    let sigLine = "Fait";
    if(poste) sigLine += ` √† ${poste}`;
    if(toText('datepv')){
      const d = new Date(toText('datepv'));
      sigLine += `, le ${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
    }
    html += para(sigLine + ".");
  }

  document.getElementById('pv').innerHTML = html;
  document.getElementById('sigAssistTitle').textContent = assistants.length>1 ? "Les Assistants" : "L‚ÄôAssistant";
  document.getElementById('signatures').style.visibility = "visible";
}

function printPV() {
  generatePV();
  setTimeout(() => {
    const sheet = document.getElementById('sheet');
    const win = window.open('', '_blank');
    win.document.write(`
      <html><head><title>Proc√®s-verbal d'interpellation</title>
        <style>
          @page { size: A4; margin: 25mm 25mm 25mm 30mm; }
          body { font-family: "Times New Roman", serif; color: black; }
          h1 { text-align: center; text-transform: uppercase; text-decoration: underline; }
          .pv { text-align: justify; line-height: 1.6; }
          .signature-row { display: flex; justify-content: space-between; margin-top: 40px; text-align: center; }
          .sig-col { flex: 1; min-height: 80px; }
          .sig-title { font-weight: bold; margin-bottom: 46px; }
        </style>
      </head>
      <body>${sheet.innerHTML}</body></html>`);
    win.document.close();
    win.focus();
    win.print();
  }, 100);
}

/* =======================
   Autosave + Sauvegardes
======================= */
const AUTO_KEY = "pv_autosave_v2";
const LIST_KEY = "pv_saved_list_v2";

function serializeForm(){
  const data = {
    poste: toText('poste'), datepv: toText('datepv'), heurepv: toText('heurepv'),
    hdeb: toText('hdeb'), hfin: toText('hfin'),
    agentGrade: toText('agentGrade'), agentNom: toText('agentNom'), agentQualite: toText('agentQualite'),
    observations: toText('observations'),
    assistants: [], esis: []
  };
  document.querySelectorAll('#assistants > .dyn-block').forEach(block=>{
    const id = block.id.replace('assistant','');
    data.assistants.push({
      grade: toText(`aGrade${id}`),
      nom: toText(`aNom${id}`),
      qualite: toText(`aQual${id}`)
    });
  });
  document.querySelectorAll('#esis > .dyn-block').forEach(block=>{
    const id = block.id.replace('esi','');
    data.esis.push({
      nom: toText(`eNom${id}`),
      jour: toText(`eJour${id}`), mois: toText(`eMois${id}`), annee: toText(`eAnnee${id}`),
      lieu: toText(`eLieu${id}`), pays: toText(`ePays${id}`), adresse: toText(`eAdresse${id}`),
      hctrl: toText(`eHctrl${id}`), hint: toText(`eHint${id}`),
      passeport: document.getElementById(`ePasseport${id}`)?.checked || false,
      titre: document.getElementById(`eTitre${id}`)?.checked || false,
      asile: document.getElementById(`eAsile${id}`)?.checked || false,
      aucun: document.getElementById(`eAucun${id}`)?.checked || false,
      autreTxt: document.getElementById(`eAutre${id}`)?.checked ? toText(`eAutreTxt${id}`) : ""
    });
  });
  return data;
}
function loadForm(data){
  document.getElementById('assistants').innerHTML = "";
  document.getElementById('esis').innerHTML = "";
  ACOUNT = 0; ECOUNT = 0;
  ['poste','datepv','heurepv','hdeb','hfin','agentGrade','agentNom','agentQualite','observations'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value=data[id]||"";
  });
  (data.assistants||[]).forEach(a=> addAssistant(a));
  (data.esis||[]).forEach(e=> addESI(e));
}
function autosave(){
  localStorage.setItem(AUTO_KEY, JSON.stringify(serializeForm()));
}
function restoreAutosave(){
  const raw = localStorage.getItem(AUTO_KEY);
  if(!raw) return addESI(); // au moins un ESI
  try{ const data = JSON.parse(raw); loadForm(data); }catch(e){ addESI(); }
}
function hookAutosave(root=document){
  root.querySelectorAll('input,select,textarea').forEach(el=>{
    el.addEventListener('input', autosave, {passive:true});
    el.addEventListener('change', autosave, {passive:true});
  });
}
function clearAll(){
  localStorage.removeItem(AUTO_KEY);
  document.getElementById('assistants').innerHTML="";
  document.getElementById('esis').innerHTML="";
  ACOUNT=0; ECOUNT=0;
  ['poste','datepv','heurepv','hdeb','hfin','agentGrade','agentNom','agentQualite','observations'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value="";
  });
  addESI();
}

function saveCurrentPV(){
  const data = serializeForm();
  const list = JSON.parse(localStorage.getItem(LIST_KEY)||"[]");
  const meta = {
    id: Date.now(),
    when: new Date().toISOString(),
    poste: data.poste||"",
    esicount: (data.esis||[]).filter(e=>e.nom && e.nom.trim()).length,
    title: `PV du ${data.datepv||'‚Äî'} ${data.heurepv||''} ‚Äî ${data.poste||'Sans poste'}`
  };
  list.unshift({ meta, data });
  localStorage.setItem(LIST_KEY, JSON.stringify(list));
  alert("PV enregistr√© dans la liste ‚úÖ");
}

function refreshSavedList(){
  const listEl = document.getElementById('savedList');
  listEl.innerHTML = "";
  const list = JSON.parse(localStorage.getItem(LIST_KEY)||"[]");
  if(list.length===0){
    listEl.innerHTML = '<div class="muted">Aucun PV enregistr√© pour le moment.</div>';
    return;
  }
  list.forEach((item, idx)=>{
    const div = document.createElement('div');
    div.className = 'item';
    const d = new Date(item.meta.when);
    const left = document.createElement('div');
    left.className='meta';
    left.innerHTML = `
      <div class="title">${item.meta.title}</div>
      <div class="sub">${d.toLocaleString()} ‚Ä¢ Poste : ${item.meta.poste||'‚Äî'} ‚Ä¢ ${item.meta.esicount} ESI</div>
    `;
    const right = document.createElement('div');
    right.className='row';
    const loadBtn = document.createElement('button');
    loadBtn.className='btn secondary';
    loadBtn.textContent='Ouvrir';
    loadBtn.onclick = ()=>{
      loadForm(item.data); autosave();
      switchTab('new'); window.scrollTo({top:0, behavior:'smooth'});
    };
    const delBtn = document.createElement('button');
    delBtn.className='btn warn';
    delBtn.textContent='Supprimer';
    delBtn.onclick = ()=>{
      const list2 = JSON.parse(localStorage.getItem(LIST_KEY)||"[]");
      list2.splice(idx,1);
      localStorage.setItem(LIST_KEY, JSON.stringify(list2));
      refreshSavedList();
    };
    right.appendChild(loadBtn); right.appendChild(delBtn);
    div.appendChild(left); div.appendChild(right);
    listEl.appendChild(div);
  });
}

document.addEventListener('DOMContentLoaded', ()=>{
  hookAutosave();
  restoreAutosave();
});
</script>

<!-- Service Worker registration -->
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .then(() => console.log("‚úÖ Service Worker enregistr√©"))
    .catch(err => console.error("Erreur SW :", err));
}
</script>

</body>
</html>
